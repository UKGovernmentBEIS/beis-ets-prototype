{% extends "layouts/admin/base.html" %}

{% set pageID = "tasks" %}

{% block pageTitle %}Tasks {{'- ' + serviceName}}{% endblock %}

{% block content %}


<div class="jui-width-container">

  <main class="govuk-main-wrapper" role="main">
  <h1 class="govuk-heading-l">Tasks</h1>

{% set searchForm %}
<form action='search' method="POST">
<div class="tile-container search nobackground">
<div class="first-cell tile-grid-cell">

        {{ govukInput({
          id: "assigned-to",
          name: "search.assignee",
          classes: "",
          label: {
            text: "Assigned to"
          },
          value: "Chris Neale"
        }) }}

          {{ govukSelect({
              id: "Task Status",
              name: "search.task.type",
              label: {
              text: "Task type"
              },
              items: [{
                  value: 'open',
                  text: 'Open',
                  selected: checked("",'')
              },{
                  value: 'closed',
                  text: 'Closed',
                  selected: checked("",'')
                  }
              ]
              }) }}
          </div>

          <div class="second-cell tile-grid-cell">

          {{ govukSelect({
              id: "Task type",
              name: "search.task.type",
              label: {
              text: "Task type"
              },
              items: [{
                  value: 'any-type',
                  text: 'Any type',
                  selected: checked("",'')
              },{
                  value: 'approve-submission',
                  text: 'Approve submission',
                  selected: checked("",'')
              },{
                  value: 'approve-transfer',
                  text: 'Approve transfer',
                  selected: checked("",'')
              },{
                  value: 'approve-surrender',
                  text: 'Approve surrender',
                  selected: checked("",'')
              }
              ]
              }) }}
          </div>
<div class="third-cell tile-grid-cell">
        {{ govukInput({
          id: "",
          name: "search.tasks.age",
          classes: "govuk-!-width-full",
          label: {
            text: "Older than (days)"
          },
          value: data.search.tasks.age
        }) }}

</div>
<div class="fourth-cell tile-grid-cell">

        {{ govukInput({
          id: "",
          name: "search.tasks.accountID",
          classes: "govuk-!-width-full",
          label: {
            text: "Account ID"
          },
          value: data.search.tasks.accountID
        }) }}

          </div>
 <div class="tile-buttons tile-grid-cell">
              <div class="accept">
                  <a href="search?q=xyz{% if query.returnAccount %}&returnAccount={{query.returnAccount}}&persist=No{% endif %}" role="button" draggable="false" class="govuk-button approve-btn">Update results</a>
              </div>
              <div class="reject">
                <a href="#" role="button" draggable="false" class="govuk-button hmcts-button--secondary reject-btn">Clear Search</a>
              </div>
        </div>
        </div>
</form>
{% endset %}

<p>Showing all open tasks assigned to you</p>

{{ govukDetails({
  summaryText: "Change filter",
  html: searchForm
}) }}


      <ul class='govuk-list'>
        {% for task in data.tasks %}
        <li>
        <div class="tile-container">
          <div class="heading tile-grid-cell">
            <div class="title">
              {{task.type}}
            </div>
            <div class="started">
              <span class="label">
                Started:
              </span>
              <span class="datetime">
                {{task.startDate}}
              </span>
            </div>
            <div class="reference">
              <span class="label">
                Reference:
              </span>
              <span class="number">
                {{task.referenceNumber}}
              </span>
            </div>
          </div>
          <div class="amount tile-grid-cell">
            {% for unit in task.units %}
              <div class="value">
                {{unit.unitAmount | formatNumber }}
              </div>
              <div class="unit">
                {{unit.unitType | safe}}
              </div>
            {% endfor %}
          </div>
          <div class="proposer tile-grid-cell">
            <div class="label">
              Requested by:
            </div>
            <div class="name">
              {{task.proposer}}
            </div>
          </div>
          {% if task.type == 'Transfer' %}
          <div class="transfer-completion tile-grid-cell hidden">
            <div class="label">
              Expected completion:
            </div>
            <div class="date">
              {{ currentDate  | date("add", 7, "days") | date("DD MMMM YYYY") }}
            </div>
          </div>
          <div class="from tile-grid-cell">
            <div class="label">
              From:
            </div>
            <div class="account-number">
              <a href="#">{{task.accountFromID}}</a>
            </div>
            <div class="account-name">
              {{task.accountFromName}}
            </div>
          </div>
          <div class="to tile-grid-cell">
            <div class="label">
              To:
            </div>
            <div class="account-number">
              <a href="#">{{task.accountToID}}</a>
            </div>
            <div class="account-name">
              {{task.accountToName}}
            </div>
          </div>
          {% endif %}
          {% if task.type == 'Surrender' %}
          <div class="from tile-grid-cell">
            <div class="label">
              From:
            </div>
            <div class="account-number">
              <a href="#">{{task.accountFromID}}</a>
            </div>
            <div class="account-name">
              {{task.accountFromName}}
            </div>
          </div>
          {% endif %}
          {% if task.type == 'Submission' %}
          <div class="from tile-grid-cell">
            <div class="label">
              From:
            </div>
            <div class="account-number">
              <a href="#">{{task.accountFromID}}</a>
            </div>
            <div class="account-name">
              {{task.accountFromName}}
            </div>
          </div>
          <div class="to tile-grid-cell">
            <div class="label">
              Verifier:
            </div>
            <div class="account-number">
              {{task.verifier}}
            </div>
          </div>
          {% endif %}
          <div class="notes tile-grid-cell">
            <div class="label">
                Notes:
            </div>
            <div class="text">
              <p>{{task.notes}}</p>
            </div>
          </div>
          <div class="tile-buttons tile-grid-cell">
            <div class="accept">
              <a href="#" role="button" draggable="false" class="govuk-button approve-btn">Approve</a>
            </div>
            <div class="reject">
              <a href="#" role="button" draggable="false" class="govuk-button hmcts-button--secondary reject-btn">Reject</a>
            </div>
        </div>
        </li>
        {% endfor %}
      </ul>
  </main>

</div>
</form>

{% endblock %}
{% block page_scripts %}
<script>
    /* global $ */
    var rejectCommentsBox = '<div class="govuk-form-group">'+
    '<label class="govuk-label" for="more-detail">Why are you rejecting this?</label>'+
    '<span id="more-detail-hint" class="govuk-hint">Please provide a reason.</span>'+
    '<textarea class="govuk-textarea" id="more-detail" name="more-detail" rows="5" aria-describedby="more-detail-hint"></textarea>'+
    '</div>'
    var twoFactorBox = '<div class="govuk-form-group">'+
    '<label class="govuk-label" for="more-detail">Enter your 2fa code</label>'+
    '<span id="2fa-hint" class="govuk-hint">Use your Google Authenticator app to generate a code</span>'+
    '<input class="govuk-input govuk-input--width-10" id="2fa-input" name="2fa-input" aria-describedby="2fa-hint"></input>'+
    '</div>'
    var defaultState = '<div class="accept">'+'<a href="#" role="button" draggable="false" class="govuk-button approve-btn">Approve</a>'+
            '</div><div class="reject">'+
              '<a href="#" role="button" draggable="false" class="govuk-button hmcts-button--secondary reject-btn">Reject</a>'
            '</div>'
    $('body').on( "click", '.govuk-button', function(e) {
        var $taskItem = $(this).parents('.tile-container')
        e.preventDefault();
        var approvedTag = '<span class="jui-status  jui-status--new">Approved</span>'
        var rejectedTag = '<span class="jui-status  jui-status--urgent">Rejected</span>'
        var content
        if ($(this).hasClass('reject-btn')){
            content = rejectCommentsBox + '<a href="#" role="button" draggable="false" class="govuk-button hmcts-button--primary final-reject-btn" style="margin-bottom: 0px;">Reject</a>'+
            '<a href="#" role="button" draggable="false" class="govuk-button govuk-!-margin-left-2 hmcts-button--secondary cancel-btn" style="margin-bottom: 0px;">Cancel</a>'
            $taskItem.find('.tile-buttons').html(content)
        }
        if ($(this).hasClass('approve-btn')){
            content = twoFactorBox + '<a href="#" role="button" draggable="false" class="govuk-button hmcts-button--primary final-approve-btn" style="margin-bottom: 0px;">Approve</a>'+
            '<a href="#" role="button" draggable="false" class="govuk-button govuk-!-margin-left-2 hmcts-button--secondary cancel-btn" style="margin-bottom: 0px;">Cancel</a>'
            $taskItem.find('.tile-buttons').html(content)
        }
        if ($(this).hasClass('final-approve-btn')){
          $taskItem.find('.tile-buttons').addClass('approved-transaction').html(approvedTag)
          $taskItem.find('.transfer-completion').show()
        }

        if ($(this).hasClass('final-reject-btn')){
            $taskItem.find('.tile-buttons').addClass('approved-transaction').html(rejectedTag)
        }
        if ($(this).hasClass('cancel-btn')){
            $taskItem.find('.tile-buttons').html(defaultState)
        }
    });
</script>
{% endblock %}
